{% extends "admin/base_site.html" %}
{% load i18n static jazzmin %}
{% get_jazzmin_ui_tweaks as jazzmin_ui %}

{% block bodyclass %}{{ block.super }} dashboard{% endblock %}

{% block content_title %} {% trans 'Dashboard' %} {% endblock %}

{% block breadcrumbs %}
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'admin:index' %}">{% trans 'Home' %}</a></li>
        <li class="breadcrumb-item">{% trans 'Dashboard' %}</li>
    </ol>
{% endblock %}


{% block content %}
    {% get_side_menu using="app_list" as dashboard_list %}
    {% if dashboard_list %}
        {% widthratio dashboard_list|length 2 1 as middle %}
    {% endif %}

    <div class="container-fluid">
        <div class="row mb-4">
            <!-- Total Users Card -->
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header bg-primary text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">Total Users</h5>
                            <h2 class="mb-0" style="padding-left: 10px;" id="total-users-count">0</h2>
                        </div>
                    </div>
                    <div class="card-body" style="height: 250px; overflow-y: auto;">
                        <div class="d-flex justify-content-between mb-2">
                            <label>Admin</label>
                            <span class="badge bg-success" style="font-size: 1.1rem; font-weight: 700;">0</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <label>student</label>
                            <span class="badge bg-info" style="font-size: 1.1rem; font-weight: 700;">0</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <label>Maintenance</label>
                            <span class="badge bg-warning" style="font-size: 1.1rem; font-weight: 700;">0</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <label>Receptionist</label>
                            <span class="badge bg-danger" style="font-size: 1.1rem; font-weight: 700;">0</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <label>Housekeep</label>
                            <span class="badge bg-secondary" style="font-size: 1.1rem; font-weight: 700;">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Total Rooms Card -->
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header bg-success text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">Total Rooms</h5>
                            <h2 class="mb-0" style="padding-left: 10px;" id="total-rooms-count">0</h2>
                        </div>
                    </div>
                    <div class="card-body" style="height: 250px; overflow-y: auto;">
                        <div class="d-flex justify-content-between mb-2">
                            <label>Occupied Rooms</label>
                            <span class="badge bg-warning" style="font-size: 1.1rem; font-weight: 700;" id="occupied-rooms-count">0</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <label>Available Rooms</label>
                            <span class="badge bg-info" style="font-size: 1.1rem; font-weight: 700;" id="available-rooms-count">0</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <label>Under Maintenance</label>
                            <span class="badge bg-secondary" style="font-size: 1.1rem; font-weight: 700;" id="maintenance-rooms-count">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Guest Logs Card -->
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header bg-info text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">Guest Logs</h5>
                            <h2 class="mb-0" style="padding-left: 10px;">85</h2>
                        </div>
                    </div>
                    <div class="card-body" style="height: 250px; overflow-y: auto;">
                        <div class="d-flex justify-content-between mb-2">
                            <label>Current Guests</label>
                            <span class="badge bg-success" style="font-size: 1.1rem; font-weight: 700;">45</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <label>Checked Out</label>
                            <span class="badge bg-secondary" style="font-size: 1.1rem; font-weight: 700;">30</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <label>Extended Stay</label>
                            <span class="badge bg-primary" style="font-size: 1.1rem; font-weight: 700;">10</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Maintenance Requests Card -->
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header bg-warning text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">Maintenance Requests</h5>
                            <h2 class="mb-0" style="padding-left: 10px;">50</h2>
                        </div>
                    </div>
                    <div class="card-body" style="height: 250px; overflow-y: auto;">
                        <div class="d-flex justify-content-between mb-2">
                            <label>Completed Requests</label>
                            <span class="badge bg-success" style="font-size: 1.1rem; font-weight: 700;">25</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <label>Pending Requests</label>
                            <span class="badge bg-danger" style="font-size: 1.1rem; font-weight: 700;">15</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <label>In Progress</label>
                            <span class="badge bg-info" style="font-size: 1.1rem; font-weight: 700;">10</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <label>Total Requests</label>
                            <span class="badge bg-secondary" style="font-size: 1.1rem; font-weight: 700;">50</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Status Card -->
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header bg-danger text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">Payment Status</h5>
                            <h2 class="mb-0" style="padding-left: 10px;">25</h2>
                        </div>
                    </div>
                    <div class="card-body" style="height: 250px; overflow-y: auto;">
                        <div class="d-flex justify-content-between mb-2">
                            <label>Total Students</label>
                            <span class="badge bg-secondary" style="font-size: 1.1rem; font-weight: 700;">25</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <label>Fee Submitted</label>
                            <span class="badge bg-success" style="font-size: 1.1rem; font-weight: 700;">18</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <label>Fee Pending</label>
                            <span class="badge bg-danger" style="font-size: 1.1rem; font-weight: 700;">7</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <label>Total Amount</label>
                            <span class="badge bg-info" style="font-size: 1.1rem; font-weight: 700;">₹250,000</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <label>Pending Amount</label>
                            <span class="badge bg-warning" style="font-size: 1.1rem; font-weight: 700;">₹70,000</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Total Bookings Card -->
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header bg-primary text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">Total Bookings</h5>
                            <h2 class="mb-0" style="padding-left: 10px;">120</h2>
                        </div>
                    </div>
                    <div class="card-body" style="height: 250px; overflow-y: auto;">
                        <div class="d-flex justify-content-between mb-2">
                            <label>Active Bookings</label>
                            <span class="badge bg-success" style="font-size: 1.1rem; font-weight: 700;">45</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <label>Completed Bookings</label>
                            <span class="badge bg-info" style="font-size: 1.1rem; font-weight: 700;">60</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <label>Cancelled Bookings</label>
                            <span class="badge bg-danger" style="font-size: 1.1rem; font-weight: 700;">15</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <label>Today's Bookings</label>
                            <span class="badge bg-warning" style="font-size: 1.1rem; font-weight: 700;">8</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <label>Total Revenue</label>
                            <span class="badge bg-secondary" style="font-size: 1.1rem; font-weight: 700;">₹350,000</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Function to get CSRF token
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            // Function to fetch and update room counts
            function updateRoomCounts() {
                const csrftoken = getCookie('csrftoken');
                console.log('Fetching room stats...');
                
                fetch('/rooms/api/dashboard/room-stats/', {
                    method: 'GET',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    mode: 'same-origin'
                })
                .then(response => {
                    console.log('Response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Received room data:', data);
                    
                    // Update total rooms count
                    const totalRoomsElement = document.getElementById('total-rooms-count');
                    if (totalRoomsElement) {
                        totalRoomsElement.textContent = data.total_rooms || 0;
                    }

                    // Update individual room counts
                    document.getElementById('occupied-rooms-count').textContent = data.occupied_rooms || 0;
                    document.getElementById('available-rooms-count').textContent = data.available_rooms || 0;
                    document.getElementById('maintenance-rooms-count').textContent = data.maintenance_rooms || 0;
                })
                .catch(error => {
                    console.error('Error fetching room stats:', error);
                    console.error('Error details:', error.message);
                });
            }

            // Function to fetch and update user counts
            function updateUserCounts() {
                const csrftoken = getCookie('csrftoken');
                console.log('Fetching user stats...');
                
                fetch('/accounts/api/dashboard/user-stats/', {
                    method: 'GET',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    mode: 'same-origin'
                })
                .then(response => {
                    console.log('Response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Received data:', data);
                    
                    // Update total users count in the header
                    const totalUsersElement = document.getElementById('total-users-count');
                    if (totalUsersElement) {
                        totalUsersElement.textContent = data.total_users || 0;
                        console.log('Updated total users:', data.total_users);
                    }
                    
                    // Update role counts in badges
                    const roleMappings = {
                        'Admin': data.admin_count || 0,
                        'student': data.student_count || 0,
                        'Maintenance': data.maintenance_count || 0,
                        'Receptionist': data.receptionist_count || 0,
                        'Housekeep': data.housekeep_count || 0
                    };

                    // Update each role count
                    Object.entries(roleMappings).forEach(([role, count]) => {
                        // Find the label containing the role name
                        const labels = document.querySelectorAll('label');
                        labels.forEach(label => {
                            if (label.textContent.trim() === role) {
                                const badge = label.nextElementSibling;
                                if (badge) {
                                    badge.textContent = count;
                                    console.log(`Updated ${role} count:`, count);
                                }
                            }
                        });
                    });
                })
                .catch(error => {
                    console.error('Error fetching user stats:', error);
                    console.error('Error details:', error.message);
                });
            }

            // Initial load
            console.log('Starting stats update...');
            updateUserCounts();
            updateRoomCounts();

            // Update every 30 seconds
            setInterval(() => {
                console.log('Refreshing stats...');
                updateUserCounts();
                updateRoomCounts();
            }, 30000);
        });
    </script>
{% endblock %}